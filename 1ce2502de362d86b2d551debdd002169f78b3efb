huge refactoring focusing no reduce source code weight and bugfixing
